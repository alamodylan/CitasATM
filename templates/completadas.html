<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Citas Completadas</title>
</head>
<body>
    <div class="container mt-5">
        <div class="mb-3">
            <a href="/" class="btn btn-info">Inicio</a>
        </div>
        <h1 class="text-center">Citas Completadas</h1>
        <a href="/vencidas" class="btn btn-danger mb-3">Ver Citas Vencidas</a>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Contenedor</th>
                    <th>Chofer</th>
                    <th>Cédula</th>
                    <th>Placa</th>
                    <th>Naviera</th>
                    <th>Fecha</th>
                    <th>Horario</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for cita in citas %}
                <tr>
                    <td>{{ cita['id'] }}</td>
                    <td>{{ cita['contenedor'] }}</td>
                    <td>{{ cita['chofer_nombre'] }}</td>
                    <td>{{ cita['chofer_cedula'] }}</td>
                    <td>{{ cita['cabezal_placa'] }}</td>
                    <td>{{ cita['naviera'] }}</td>
                    <td>{{ cita['fecha'] }}</td>
                    <td>{{ cita['horario'] }}</td>
                    <td>
                        <a href="/generar-pdf/{{ cita['id'] }}" class="btn btn-secondary btn-sm">Descargar PDF</a>
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#codigoModalRevertir" data-id="{{ cita['id'] }}">Regresar a Pendientes</button>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalSubirFotos" data-id="{{ cita['id'] }}">Subir Fotos</button>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalVerFotos" data-id="{{ cita['id'] }}">Ver Fotos</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal para regresar a pendientes -->
    <div class="modal fade" id="codigoModalRevertir" tabindex="-1" aria-labelledby="codigoModalRevertirLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="codigoModalRevertirLabel">Regresar a Pendientes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Introduce el código de autorización:</p>
                    <input type="password" id="codigo_autorizacion_revertir" class="form-control" placeholder="Código" required>
                    <div id="revertirError" class="text-danger mt-2" style="display: none;">Código incorrecto.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="validarCodigoRevertir()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para subir fotos -->
    <div class="modal fade" id="modalSubirFotos" tabindex="-1" aria-labelledby="modalSubirFotosLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalSubirFotosLabel">Subir Fotos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formSubirFotos" action="" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="foto1" class="form-label">Foto 1</label>
                            <input type="file" class="form-control" name="foto1" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="foto2" class="form-label">Foto 2</label>
                            <input type="file" class="form-control" name="foto2" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="foto3" class="form-label">Foto 3</label>
                            <input type="file" class="form-control" name="foto3" accept="image/*">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Fotos</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalVerFotos" tabindex="-1" aria-labelledby="modalVerFotosLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVerFotosLabel">Fotos de la Cita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="fotosContainer" class="d-flex flex-wrap justify-content-center"></div>
                    <p id="noFotosMsg" class="text-center text-muted mt-3" style="display: none;">No hay fotos disponibles para esta cita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('modalVerFotos').addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Botón que disparó el modal
            const citaId = button.getAttribute('data-id'); // ID de la cita asociada
            const fotosContainer = document.getElementById('fotosContainer');
            const noFotosMsg = document.getElementById('noFotosMsg');
    
            // Limpiar el contenedor de fotos antes de cargar nuevas
            fotosContainer.innerHTML = '';
            noFotosMsg.style.display = 'none';
    
            // Hacer la solicitud para obtener las fotos
            fetch(`/ver-fotos/${citaId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.fotos && data.fotos.length > 0) {
                        data.fotos.forEach(foto => {
                            const img = document.createElement('img');
                            img.src = foto;
                            img.alt = "Foto de la cita";
                            img.classList.add('img-thumbnail', 'm-2');
                            img.style.maxWidth = '200px';
                            fotosContainer.appendChild(img);
                        });
                    } else {
                        noFotosMsg.style.display = 'block';
                    }
                })
                .catch(error => console.error("Error al cargar las fotos:", error));
        });
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
